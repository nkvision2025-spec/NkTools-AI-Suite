<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NkTools - AI Generator Suite Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .active-tab { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-glow:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transition: all 0.3s; }
        .tool-section { transition: all 0.4s ease; }
        .hidden { display: none; }
        .result-img { max-height: 400px; width: auto; margin: 0 auto; border-radius: 12px; }
        .api-locked-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); z-index: 40; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    </style>
</head>
<body class="min-h-screen">

    <!-- API Lock Screen -->
    <div id="api-lock-screen" class="api-locked-overlay hidden">
        <div class="glass p-8 rounded-3xl border border-blue-500/50 max-w-sm">
            <i class="fas fa-lock text-4xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-bold mb-2">Access Locked</h2>
            <p class="text-sm text-slate-400 mb-6">Pehle Settings mein jaakar apni API Key paste karein.</p>
            <button onclick="toggleSettings()" class="bg-blue-600 px-6 py-2 rounded-full font-bold hover:bg-blue-500 transition">Open Settings</button>
        </div>
    </div>

    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fas fa-bolt text-yellow-400 text-2xl"></i>
            <span class="text-xl font-bold tracking-tight">NkTools <span class="text-blue-500 text-sm">Pro</span></span>
        </div>
        <div class="hidden lg:flex gap-4 text-sm font-medium">
            <button onclick="switchTab('i2p')" class="tab-btn px-2 py-2" id="tab-i2p">Image to Prompt</button>
            <button onclick="switchTab('p2i')" class="tab-btn px-2 py-2" id="tab-p2i">Prompt to Image</button>
            <button onclick="switchTab('changer')" class="tab-btn px-2 py-2" id="tab-changer">Pro Changer</button>
            <button onclick="switchTab('video')" class="tab-btn active-tab px-2 py-2" id="tab-video">AI Video</button>
            <button onclick="switchTab('gallery')" class="tab-btn px-2 py-2" id="tab-gallery"><i class="fas fa-images mr-1"></i> Gallery</button>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition-all text-xl p-2 relative">
                <i class="fas fa-cog"></i>
                <span id="api-warning-dot" class="absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full hidden animate-ping"></span>
            </button>
            <div id="api-status-dot" class="h-3 w-3 rounded-full bg-red-500" title="API Status"></div>
        </div>
    </nav>

    <!-- API Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="glass p-8 rounded-3xl w-full max-w-md mx-4 relative border border-blue-500/30 shadow-2xl">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-blue-400">
                <i class="fas fa-shield-alt"></i> API Settings
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Google Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-blue-500 outline-none" placeholder="Paste key here...">
                </div>
                <button onclick="saveApiKey()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-sm transition-all shadow-lg">SAVE KEY</button>
                <button onclick="deleteApiKey()" class="w-full text-red-400 text-xs hover:underline">Remove Key</button>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- Video Tool -->
        <section id="sec-video" class="tool-section">
            <div class="glass p-6 rounded-2xl max-w-3xl mx-auto">
                <h1 class="text-2xl font-bold mb-4 text-blue-400">AI Video Motion</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="border-2 border-dashed border-slate-700 rounded-xl p-4 text-center cursor-pointer" onclick="document.getElementById('video-input').click()">
                        <input type="file" id="video-input" class="hidden" accept="image/*" onchange="previewImage(this, 'video-prev')">
                        <img id="video-prev-img" class="hidden h-32 w-full object-contain mx-auto">
                        <div id="video-prev-txt"><i class="fas fa-image text-2xl mb-2 text-slate-600"></i><p class="text-xs">Upload Photo</p></div>
                    </div>
                    <textarea id="video-prompt" class="w-full bg-slate-900/60 p-3 rounded-xl text-sm border border-slate-800" placeholder="Describe movement..."></textarea>
                </div>
                <button onclick="generateVideo()" class="w-full bg-blue-600 py-4 rounded-xl font-bold btn-glow">GENERATE VIDEO</button>
                <div id="video-result-container" class="mt-8 hidden">
                    <video id="video-player" class="w-full rounded-xl border-4 border-slate-800" controls loop muted></video>
                </div>
            </div>
        </section>

        <!-- P2I Tool -->
        <section id="sec-p2i" class="tool-section hidden">
            <div class="glass p-8 rounded-2xl max-w-3xl mx-auto">
                <h1 class="text-2xl font-bold mb-4 text-green-400">Prompt to Image</h1>
                <textarea id="p2i-prompt" class="w-full bg-slate-900/60 border border-slate-800 p-4 rounded-xl mb-6 text-sm outline-none" placeholder="Describe image..."></textarea>
                <button onclick="promptToImage()" class="w-full bg-green-600 py-4 rounded-xl font-bold">GENERATE</button>
                <div id="p2i-result-container" class="mt-8 hidden">
                    <img id="p2i-img" class="result-img border-4 border-slate-800">
                </div>
            </div>
        </section>

        <!-- I2P Tool -->
        <section id="sec-i2p" class="tool-section hidden">
            <div class="glass p-8 rounded-2xl max-w-3xl mx-auto">
                <h1 class="text-2xl font-bold mb-4 text-yellow-400">Image to Prompt</h1>
                <div class="border-2 border-dashed border-slate-700 rounded-xl p-6 mb-6 text-center cursor-pointer" onclick="document.getElementById('i2p-input').click()">
                    <input type="file" id="i2p-input" class="hidden" accept="image/*" onchange="previewImage(this, 'i2p-prev')">
                    <img id="i2p-prev-img" class="hidden h-40 mx-auto rounded-lg mb-4">
                    <div id="i2p-prev-txt"><i class="fas fa-search text-4xl mb-2 text-slate-600"></i><p>Select Photo</p></div>
                </div>
                <button onclick="imageToPrompt()" class="w-full bg-yellow-600 py-4 rounded-xl font-bold">ANALYZE</button>
                <div id="i2p-result-box" class="mt-6 p-4 bg-black/40 rounded-xl border border-slate-800 hidden">
                    <div id="i2p-text" class="text-sm text-slate-300 italic mb-4"></div>
                    <button onclick="copyToClipboard('i2p-text')" class="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold">Copy Prompt</button>
                </div>
            </div>
        </section>

        <!-- Changer Tool -->
        <section id="sec-changer" class="tool-section hidden">
            <div class="glass p-8 rounded-2xl max-w-3xl mx-auto">
                <h1 class="text-2xl font-bold mb-4 text-purple-400">Pro Changer</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="border-2 border-dashed border-slate-700 rounded-xl p-4 text-center cursor-pointer" onclick="document.getElementById('edit-input').click()">
                        <input type="file" id="edit-input" class="hidden" accept="image/*" onchange="previewImage(this, 'edit-prev')">
                        <img id="edit-prev-img" class="hidden h-32 mx-auto rounded-lg">
                        <div id="edit-prev-txt"><i class="fas fa-edit text-2xl mb-2 text-slate-600"></i><p>Upload</p></div>
                    </div>
                    <textarea id="edit-prompt" class="w-full bg-slate-900/60 p-3 rounded-xl text-sm border border-slate-800" placeholder="Instructions..."></textarea>
                </div>
                <button onclick="editImage()" class="w-full bg-purple-600 py-4 rounded-xl font-bold">CHANGE</button>
                <div id="edit-result-container" class="mt-8 hidden">
                    <img id="edit-img" class="result-img border-4 border-slate-800">
                </div>
            </div>
        </section>

        <!-- Gallery -->
        <section id="sec-gallery" class="tool-section hidden">
            <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </section>
    </main>

    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[100] flex flex-col items-center justify-center hidden">
        <div class="loader h-12 w-12 mb-4 border-4 border-slate-700 rounded-full"></div>
        <p id="loading-text" class="text-xs font-bold text-blue-400 uppercase"></p>
    </div>

    <script>
        const API_KEY_KEY = 'nk_api_key_v2';
        let currentApiKey = localStorage.getItem(API_KEY_KEY) || "";

        // Updated models to avoid "no longer available" errors
        const STABLE_MODEL = 'gemini-2.0-flash';
        const IMAGE_GEN_MODEL = 'imagen-3.0-generate-001'; 
        const MOTION_MODEL = 'gemini-2.0-flash-exp'; // Use experimental for advanced media

        window.onload = () => {
            if (!currentApiKey) {
                document.getElementById('api-lock-screen').classList.remove('hidden');
            } else {
                document.getElementById('api-status-dot').classList.replace('bg-red-500', 'bg-green-500');
            }
        };

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem(API_KEY_KEY, key);
                location.reload();
            }
        }

        function deleteApiKey() {
            localStorage.removeItem(API_KEY_KEY);
            location.reload();
        }

        // Modified Fetcher with cleaner error handling
        async function callAI(endpoint, payload, modelName = STABLE_MODEL) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:${endpoint}?key=${currentApiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || "Model limit reached or error.");
                }
                
                return data;
            } catch (e) {
                console.error("AI Call failed:", e);
                throw e;
            }
        }

        function toggleLoading(show, text = "") {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
            document.getElementById('loading-text').innerText = text;
        }

        function switchTab(id) {
            document.querySelectorAll('.tool-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(`sec-${id}`).classList.remove('hidden');
            document.getElementById(`tab-${id}`).classList.add('active-tab');
        }

        function previewImage(input, pid) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById(pid + '-img').src = e.target.result;
                    document.getElementById(pid + '-img').classList.remove('hidden');
                    document.getElementById(pid + '-txt').classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        async function imageToPrompt() {
            const file = document.getElementById('i2p-input').files[0];
            if (!file) return alert("Select a photo!");
            toggleLoading(true, "Analysing...");
            
            try {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const data = await callAI('generateContent', {
                    contents: [{ parts: [
                        { text: "Describe this image in detail for an AI image generator prompt. Output only the prompt." },
                        { inlineData: { mimeType: file.type, data: base64 } }
                    ]}]
                }, STABLE_MODEL);

                const promptText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (promptText) {
                    document.getElementById('i2p-text').innerText = promptText;
                    document.getElementById('i2p-result-box').classList.remove('hidden');
                } else {
                    alert("Model responded but prompt was empty. Try again.");
                }
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function promptToImage() {
            const prompt = document.getElementById('p2i-prompt').value;
            if (!prompt) return;
            toggleLoading(true, "Generating...");

            try {
                // For Imagen, we use the prediction endpoint
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_GEN_MODEL}:predict?key=${currentApiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: [{ prompt }], parameters: { sampleCount: 1 } })
                });
                
                const data = await res.json();
                
                if (data.predictions && data.predictions[0]) {
                    const b64 = data.predictions[0].bytesBase64Encoded;
                    document.getElementById('p2i-img').src = `data:image/png;base64,${b64}`;
                    document.getElementById('p2i-result-container').classList.remove('hidden');
                } else {
                    throw new Error(data.error?.message || "Could not generate image.");
                }
            } catch (e) {
                alert("Fail: " + e.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function generateVideo() {
            const prompt = document.getElementById('video-prompt').value;
            const file = document.getElementById('video-input').files[0];
            if (!file || !prompt) return alert("Both fields required!");
            toggleLoading(true, "Creating Motion...");

            try {
                const base64 = await new Promise(r => {
                    const rd = new FileReader();
                    rd.onload = () => r(rd.result.split(',')[1]);
                    rd.readAsDataURL(file);
                });

                const data = await callAI('generateContent', {
                    contents: [{ parts: [
                        { text: `Create a video motion of this: ${prompt}` },
                        { inlineData: { mimeType: file.type, data: base64 } }
                    ]}],
                    generationConfig: { responseModalities: ["IMAGE"] } // Motion often returns frame sequence or single generation
                }, MOTION_MODEL);

                const part = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (part) {
                    const mime = part.inlineData.mimeType;
                    const blob = `data:${mime};base64,${part.inlineData.data}`;
                    if (mime.includes('video')) {
                        document.getElementById('video-player').src = blob;
                        document.getElementById('video-result-container').classList.remove('hidden');
                    } else {
                        // If it returns image as motion fallback
                        alert("Returned as high quality motion frame.");
                    }
                }
            } catch (e) {
                alert("Motion Error: " + e.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function editImage() {
            const file = document.getElementById('edit-input').files[0];
            const prompt = document.getElementById('edit-prompt').value;
            if (!file || !prompt) return;
            toggleLoading(true, "Editing...");

            try {
                const b64 = await new Promise(r => {
                    const rd = new FileReader();
                    rd.onload = () => r(rd.result.split(',')[1]);
                    rd.readAsDataURL(file);
                });

                const data = await callAI('generateContent', {
                    contents: [{ parts: [
                        { text: `Modify this image: ${prompt}` },
                        { inlineData: { mimeType: file.type, data: b64 } }
                    ]}],
                    generationConfig: { responseModalities: ["IMAGE"] }
                }, STABLE_MODEL);

                const outPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (outPart) {
                    document.getElementById('edit-img').src = `data:image/png;base64,${outPart.inlineData.data}`;
                    document.getElementById('edit-result-container').classList.remove('hidden');
                }
            } catch (e) {
                alert("Edit Fail: " + e.message);
            } finally {
                toggleLoading(false);
            }
        }

        function copyToClipboard(id) {
            const text = document.getElementById(id).innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Copied!");
        }
    </script>
</body>
</html>